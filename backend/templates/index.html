<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库备份工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <h1>数据库备份工具</h1>

        <form id="backupForm">
            <div class="form-group">
                <label>数据库类型：</label>
                <select name="db_type" id="dbType" required>
                    <option value="mysql">MySQL</option>
                    <option value="postgresql">PostgreSQL</option>
                    <option value="sqlite">SQLite</option>
                </select>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_docker" id="isDocker"> Docker部署
                </label>
            </div>

            <div id="dockerContainer" class="form-group" style="display: none;">
                <label>容器名称：</label>
                <input type="text" name="container_name" id="containerName">
            </div>

            <!-- MySQL配置 -->
            <div id="mysqlConfig" class="db-config">
                <div class="form-group">
                    <label>主机：</label>
                    <input type="text" name="mysql_host" value="localhost" required>
                </div>
                <div class="form-group">
                    <label>端口：</label>
                    <input type="number" name="mysql_port" value="3306" required>
                </div>
                <div class="form-group">
                    <label>用户名：</label>
                    <input type="text" name="mysql_user" required>
                </div>
                <div class="form-group">
                    <label>密码：</label>
                    <input type="password" name="mysql_password" required>
                </div>
                <div class="form-group">
                    <label>数据库名：</label>
                    <input type="text" name="mysql_database" required>
                </div>
            </div>

            <!-- PostgreSQL配置 -->
            <div id="postgresqlConfig" class="db-config" style="display: none;">
                <div class="form-group">
                    <label>主机：</label>
                    <input type="text" name="pg_host" value="localhost" required>
                </div>
                <div class="form-group">
                    <label>端口：</label>
                    <input type="number" name="pg_port" value="5432" required>
                </div>
                <div class="form-group">
                    <label>用户名：</label>
                    <input type="text" name="pg_user" required>
                </div>
                <div class="form-group">
                    <label>密码：</label>
                    <input type="password" name="pg_password" required>
                </div>
                <div class="form-group">
                    <label>数据库名：</label>
                    <input type="text" name="pg_database" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="incremental"> 增量备份
                    </label>
                </div>
            </div>

            <!-- SQLite配置 -->
            <div id="sqliteConfig" class="db-config" style="display: none;">
                <div class="form-group">
                    <label>数据库路径：</label>
                    <input type="text" name="sqlite_path" required>
                </div>
            </div>

            <button type="submit" class="btn">开始备份</button>
        </form>

        <div id="result"></div>

        <h2>备份历史</h2>
        <button id="refreshBackups" class="btn">刷新列表</button>
        <div id="backupsList"></div>
    </div>

    <script>
        // 显示/隐藏Docker容器名称输入框
        document.getElementById('isDocker').addEventListener('change', function() {
            document.getElementById('dockerContainer').style.display = this.checked ? 'block' : 'none';
        });

        // 根据数据库类型显示对应配置
        document.getElementById('dbType').addEventListener('change', function() {
            document.querySelectorAll('.db-config').forEach(el => el.style.display = 'none');
            document.getElementById(this.value + 'Config').style.display = 'block';
        });

        // 表单提交处理
        document.getElementById('backupForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const resultDiv = document.getElementById('result');

            resultDiv.innerHTML = '<p>备份中，请稍候...</p>';

            fetch('/backup', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <p>${data.message}</p>
                            <a href="${data.download_url}" class="btn">下载备份文件</a>
                        </div>
                    `;
                    loadBackups();
                } else {
                    resultDiv.innerHTML = `<div class="error">${data.message}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div class="error">请求失败：${error}</div>`;
            });
        });

        // 加载备份列表
        function loadBackups() {
            fetch('/backups')
            .then(response => response.json())
            .then(backups => {
                const listDiv = document.getElementById('backupsList');
                if (backups.length === 0) {
                    listDiv.innerHTML = '<p>暂无备份记录</p>';
                    return;
                }

                let html = '<table><tr><th>文件名</th><th>大小</th><th>创建时间</th><th>操作</th></tr>';
                backups.forEach(backup => {
                    html += `
                        <tr>
                            <td>${backup.name}</td>
                            <td>${formatBytes(backup.size)}</td>
                            <td>${backup.created}</td>
                            <td><a href="${backup.download_url}" class="btn">下载</a></td>
                        </tr>
                    `;
                });
                html += '</table>';
                listDiv.innerHTML = html;
            });
        }

        // 刷新备份列表
        document.getElementById('refreshBackups').addEventListener('click', loadBackups);

        // 格式化文件大小
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // 页面加载时获取备份列表
        window.onload = loadBackups;
    </script>
</body>
</html>
